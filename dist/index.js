const L=(e,t)=>{e()||(t(),requestAnimationFrame(()=>L(e,t)))},M=(e,t,c=0)=>{c<e&&(t(c),requestAnimationFrame(()=>M(e,t,c+1)))},v=e=>{e(),requestAnimationFrame(()=>v(e))},T=[{type:"image",name:"iyowa",src:"./assets/iyowa.png"},{type:"image",name:"igusuri_kk",src:"./assets/igusuri_kk.png"},{type:"image",name:"igusuri_ap",src:"./assets/igusuri_ap.png"},{type:"image",name:"igusuri_kn",src:"./assets/igusuri_kn.png"},{type:"image",name:"igusuri_lm",src:"./assets/igusuri_lm.png"},{type:"image",name:"achieve_box",src:"./assets/wide_iyowa.png"},{type:"font",name:"Zen Kurenaido",src:"https://fonts.googleapis.com/css2?family=Zen+Kurenaido&display=swap"}],S=async()=>{const e={},t={},c={},y=T,s=[];return console.log(y),y.forEach(o=>s.push(new Promise(n=>{switch(o.type){case"image":{const a=new Image;a.src=o.src,a.onload=()=>{e[o.name]=a,n()}}break;case"audio":{const a=new Audio;a.src=o.src,a.onload=()=>{t[o.name]=a,n()}}break;case"font":(async()=>{const h=await(await(await fetch(o.src)).text()).match(/url\(.+?\)/g);if(!h)throw new Error("フォントが見つかりませんでした");const l=[];h.forEach(p=>{l.push((async()=>{const i=new FontFace(o.name,p);await i.load(),c[o.name]=i,await document.fonts.add(i)})())}),Promise.all(l)})().then(n)}}))),await Promise.all(s),console.log(c),{Images:e,Audios:t,Fonts:c}},f=e=>Math.sin(e/360*Math.PI*2),q=e=>Math.cos(e/360*Math.PI*2),A=(e,t,c,y)=>Math.sqrt((c-e)**2+(y-t)**2),F=(e,t,c,y,s,o)=>{const n=(l,p,i,u=0,d=100,_=1,w="center",k=!1)=>{if(k){const g=c[l],m=g.width,b=g.height;switch(t.globalAlpha=_,w){case"center":t.save(),t.translate(p*s.display_quality,-i*s.display_quality+e.height),t.rotate(u*Math.PI/180),t.drawImage(g,-m*d/200*s.display_quality,-b*d/200*s.display_quality,m*d/100*s.display_quality,b*d/100*s.display_quality),t.restore();break;case"start":t.save(),t.translate(p*s.display_quality,-i*s.display_quality+e.height),t.rotate(u*Math.PI/180),t.drawImage(g,0,0,m*d/100*s.display_quality,b*d/100*s.display_quality),t.restore()}}else{const g=(q(o.d)*p-f(o.d)*i+o.x)*o.size/100,m=(f(o.d)*p+q(o.d)*i+o.y)*o.size/100,b=u+o.d;n(l,g,m,b,d*o.size/100,_,w,!0)}};return{stamp:n,drawRect:(l,p,i,u,d,_=0,w="center")=>{switch(t.save(),w){case"center++":t.translate(l*s.display_quality,-p*s.display_quality+e.height),t.rotate(_*Math.PI/180),t.beginPath(),t.rect(-i/2*s.display_quality,-u/2*s.display_quality,i*s.display_quality,u*s.display_quality);break;case"center":t.translate((l-i/2)*s.display_quality,-(p-u/2)*s.display_quality+e.height),t.rotate(_*Math.PI/180),t.beginPath(),t.rect(0,0,i*s.display_quality,-u*s.display_quality);break;case"start":default:t.translate(l*s.display_quality,-p*s.display_quality+e.height),t.rotate(_*Math.PI/180),t.beginPath(),t.rect(0,0,i*s.display_quality,-u*s.display_quality);break}t.fillStyle=d,t.fill(),t.restore()},drawLine:(l,p,i,u,d,_,w=0)=>{switch(t.beginPath(),w){case 0:t.moveTo((l-u*Math.sin(i)/2)*s.display_quality,-(p+u*Math.cos(i)/2)*s.display_quality+e.height),t.lineTo((l+u*Math.sin(i)/2)*s.display_quality,-(p-u*Math.cos(i)/2)*s.display_quality+e.height);break;case 1:t.moveTo(l*s.display_quality,-p*s.display_quality+e.height),t.lineTo((l+u*Math.sin(i))*s.display_quality,-(p-u*Math.cos(i))*s.display_quality+e.height);break}t.strokeStyle=_,t.lineWidth=d*s.display_quality,t.stroke()},drawText:(l,p,i,u,d,_="serif",w="left")=>{const[k,g]=[p*s.display_quality,-i*s.display_quality+e.height];t.font=`${u*s.display_quality}px ${_}`,t.textAlign=w,t.fillStyle=d,t.fillText(l,k,g)}}},R=e=>{class t{constructor(y,s,o=0,n=100,a="",r=!1){this.x=y,this.y=s,this.d=o,this.size=n,this.costume=a,this.visible=r}stamp(){this.visible&&e.stamp(this.costume,this.x,this.y,this.d,this.size)}move(y){this.x+=f(this.d)*y,this.y+=q(this.d)*y}}return t},x=(e,t,c)=>({raw_to_stage:(s,o,n=0)=>{const a=e.getBoundingClientRect(),r=((s-a.left)/c.size*100-c.x)*t.stage_width/t.display_width,h=(t.display_height-((o-a.top)/c.size*100-c.y))*t.stage_height/t.display_height,l=n+c.d;return{x:r,y:h,d:l}}}),E=async e=>{const t=document.getElementById(e.canvas_name);t.height=e.stage_height*e.display_quality,t.width=e.stage_width*e.display_quality;const c=t.getContext("2d"),{Images:y,Audios:s,Fonts:o}=await S(),n={up:!1,down:!1,left:!1,right:!1,z:!1,x:!1,c:!1,d:!1},a={x:0,y:0,clicking:!1,is_in_rect(i,u,d,_,w="center"){switch(w){case"center":return i-d/2<this.x&&this.x<i+d/2&&u-_/2<this.y&&this.y<u+_/2;case"start":default:return i<this.x&&this.x<i+d&&u<this.y&&this.y<u+_}}},r={canvas:{size:100,x:0,y:0,d:0}},h=F(t,c,y,o,e,r.canvas),l=R(h);c.imageSmoothingEnabled=!1;const p=x(t,e,r.canvas);return window.addEventListener("keydown",i=>{switch(i.key){case"ArrowUp":n.up=!0;break;case"ArrowDown":n.down=!0;break;case"ArrowLeft":n.left=!0;break;case"ArrowRight":n.right=!0;break;case"z":case"Z":n.z=!0;break;case"x":case"X":n.x=!0;break;case"c":case"C":n.c=!0;break;case"d":case"D":n.d=!0;break}}),window.addEventListener("keyup",i=>{switch(i.key){case"ArrowUp":n.up=!1;break;case"ArrowDown":n.down=!1;break;case"ArrowLeft":n.left=!1;break;case"ArrowRight":n.right=!1;break;case"z":case"Z":n.z=!1;break;case"x":case"X":n.x=!1;break;case"c":case"C":n.c=!1;break;case"d":case"D":n.d=!1;break}}),t.addEventListener("mousedown",i=>{a.clicking=!0;const u=p.raw_to_stage(i.x,i.y);a.x=u.x,a.y=u.y}),t.addEventListener("mousemove",i=>{const u=p.raw_to_stage(i.x,i.y);a.x=u.x,a.y=u.y}),t.addEventListener("mouseup",i=>{a.clicking=!1;const u=p.raw_to_stage(i.x,i.y);a.x=u.x,a.y=u.y}),{canvas:t,ctx:c,Images:y,Audios:s,Fonts:o,inputKeys:n,inputMouse:a,props:r,cLib:h,Sprite:l,for:M,while:L,loop:v}},P=2,z=800,I=480,j=1e3,$=600,K="canvas",Z={display_quality:P,stage_width:z,stage_height:I,display_width:j,display_height:$,canvas_name:K},C=(e,t)=>{const c={},y=[],s=(a,r,h)=>{if(c[a]===void 0){const l={title:r,explain:h,age:0,life:100};c[a]=l,y.push(l),console.log(`実績"${r}"を解除しました。`)}};return{dict:c,render_queue:y,check:()=>{1<=t.iyowa&&s("test_1","テスト実績1","テスト実績1の説明文"),2<=t.iyowa&&s("test_2","テスト実績2","テスト実績2の説明文"),3<=t.iyowa&&s("test_3","テスト実績3","テスト実績3の説明文"),4<=t.iyowa&&s("test_4","テスト実績4","テスト実績4の説明文"),5<=t.iyowa&&s("test_5","テスト実績5","テスト実績5の説明文"),148<=t.iyowa&&s("iyowa_1","胃が弱いからいよわです","解放条件:148いよわ生産する")},unlock:s,render:()=>{for(let a=0;a<Math.min(3,y.length);a++){const r=y[a];if(r.age+=1,r.life<r.age){y.shift(),a-=1;continue}const h=((l,p)=>l<15?l/15:p-15<l?(p-l)/15:1)(r.age,r.life);e.cLib.stamp("achieve_box",160,90+a*120,0,65,h,"center"),e.cLib.drawText(r.title,160,110+a*120,20,"black","Zen Kurenaido","center"),e.cLib.drawText(`${r.explain}`,25,85+a*120,15,"black","Zen Kurenaido","start")}}}},D=(e,t)=>{class c{constructor(s,o,n,a,r){this.igusuri={name:s,image:o,price:n,price_real:n,perf:0,perf_real:1,price_ratio:a,perf_ratio:r,level:1}}buy_igusuri(){e.iyowa-=this.igusuri.price,this.igusuri.perf_real=this.igusuri.perf_real*this.igusuri.perf_ratio,this.igusuri.price_real=this.igusuri.price_real*this.igusuri.price_ratio,this.igusuri.price=Math.floor(this.igusuri.price_real),this.igusuri.perf=Math.floor(this.igusuri.perf_real)-1,this.igusuri.level+=1}}return c},G=async()=>{const e=await E(Z);let t=0;class c extends e.Sprite{constructor(h,l,p,i,u,d,_){super(h,l,p,20,"iyowa",!0),this.jump_x=i,this.jump_y=u,this.jump_d=d,this.age=0,this.life=_}proc(){this.x+=this.jump_x,this.y+=this.jump_y,this.d+=this.jump_d,this.jump_y-=.5,this.age+=1}}const y=new e.Sprite(160,240,0,100,"iyowa",!0),s={iyowa:0,ipc:1,ips:0,shop_tab:"igusuri",opus:[]},o=D(s),n=C(e,s);s.opus=[new o("きゅうくらりん","igusuri_kk",10,1.3,1.25),new o("あだぽしゃ","igusuri_ap",10,1.3,1.25),new o("1000年生きてる","igusuri_lm",10,1.3,1.25),new o("くろうばあないと","igusuri_kn",10,1.3,1.25)];const a={};window.addEventListener("mousedown",r=>{if(A(y.x,y.y,e.inputMouse.x,e.inputMouse.y)<70)a[t]=new c(e.inputMouse.x,e.inputMouse.y,0,Math.random()*9-3,Math.random()*7+6,Math.random()*10,100),y.size+=30,s.iyowa+=s.ipc;else if(e.inputMouse.clicking)if(e.inputMouse.is_in_rect(400,345,160,30,"center"))s.shop_tab="igusuri";else if(e.inputMouse.is_in_rect(560,345,160,30,"center"))s.shop_tab="girls";else if(e.inputMouse.is_in_rect(720,345,160,30,"center"))s.shop_tab="gacha";else{s.ipc=1;for(let h=0;h<s.opus.length;h++){const l=s.opus[h],p=s.opus[h].igusuri;e.inputMouse.is_in_rect(480,290-h*60,300,60,"center")&&p.price<=s.iyowa&&l.buy_igusuri(),s.ipc+=p.perf}}}),e.loop(()=>{t++,y.d=f(t*2)*5,y.size=Math.max(75,40+y.size*.6),n.check(),e.inputKeys.d&&(s.ipc+=100),e.ctx.clearRect(0,0,e.canvas.width,e.canvas.height),y.stamp();for(const r in a){const h=a[r];h.age<h.life?(h.proc(),h.stamp()):delete a[r]}switch(e.cLib.drawText(`${s.iyowa.toLocaleString()} iyowa`,160,430,30,"white","serif","center"),e.cLib.drawText(`${s.ipc.toLocaleString()} ipc`,160,405,20,"white","serif","center"),e.cLib.drawText(`${s.ips.toLocaleString()} ips`,160,380,20,"white","serif","center"),e.cLib.drawRect(320,0,480,480,"#b88e98",0,"start"),e.cLib.drawRect(400,345,160,30,s.shop_tab=="igusuri"?"#eee":"#fff",0,"center++"),e.cLib.drawRect(560,345,160,30,s.shop_tab=="girls"?"#eee":"#fff",0,"center++"),e.cLib.drawRect(720,345,160,30,s.shop_tab=="gacha"?"#eee":"#fff",0,"center++"),e.cLib.drawText("Shop",560,400,50,"white","serif","center"),e.cLib.drawText("igusuri",400,340,20,"black","serif","center"),e.cLib.drawText("girls",560,340,20,"black","serif","center"),e.cLib.drawText("gacha",720,340,20,"black","serif","center"),s.shop_tab){case"igusuri":{e.cLib.drawRect(320,0,480,330,"#a87e88",0,"start");for(let r=0;r<s.opus.length;r++){const h=s.opus[r].igusuri;e.inputMouse.is_in_rect(560,290-r*60,440,60,"center")?e.cLib.drawRect(560,290-r*60,460,60,"#c89ea8",0,"center++"):e.cLib.drawRect(560,290-r*60,460,60,"#b88e98",0,"center++"),e.cLib.stamp(h.image,360,290-r*60,0,200),e.cLib.drawText(h.name,400,295-r*60,20,"white","Zen Kurenaido","start"),e.cLib.drawText(`Lv: ${h.level.toLocaleString()} | price: ${h.price.toLocaleString()} iyowa`,400,270-r*60,15,"white","Serif","start")}}}n.render()})};window.onload=G;
