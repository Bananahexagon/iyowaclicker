const L=(e,t)=>{e()||(t(),requestAnimationFrame(()=>L(e,t)))},M=(e,t,y=0)=>{y<e&&(t(y),requestAnimationFrame(()=>M(e,t,y+1)))},v=e=>{e(),requestAnimationFrame(()=>v(e))},A=[{type:"image",name:"iyowa",src:"./assets/iyowa.png"},{type:"image",name:"igusuri_kk",src:"./assets/igusuri_kk.png"},{type:"image",name:"igusuri_ap",src:"./assets/igusuri_ap.png"},{type:"image",name:"igusuri_kn",src:"./assets/igusuri_kn.png"},{type:"image",name:"igusuri_lm",src:"./assets/igusuri_lm.png"},{type:"image",name:"achieve_box",src:"./assets/wide_iyowa.png"},{type:"font",name:"Zen Kurenaido",src:"https://fonts.googleapis.com/css2?family=Zen+Kurenaido&display=swap"}],T=async()=>{const e={},t={},y={},d=A,a=[];return console.log(d),d.forEach(u=>a.push(new Promise(s=>{switch(u.type){case"image":{const h=new Image;h.src=u.src,h.onload=()=>{e[u.name]=h,s()}}break;case"audio":{const h=new Audio;h.src=u.src,h.onload=()=>{t[u.name]=h,s()}}break;case"font":(async()=>{const c=await(await(await fetch(u.src)).text()).match(/url\(.+?\)/g);if(!c)throw new Error("フォントが見つかりませんでした");const r=[];c.forEach(o=>{r.push((async()=>{const i=new FontFace(u.name,o);await i.load(),y[u.name]=i,await document.fonts.add(i)})())}),Promise.all(r)})().then(s)}}))),await Promise.all(a),console.log(y),{Images:e,Audios:t,Fonts:y}},f=e=>Math.sin(e/360*Math.PI*2),q=e=>Math.cos(e/360*Math.PI*2),P=(e,t,y,d)=>Math.sqrt((y-e)**2+(d-t)**2),S=(e,t,y,d,a,u)=>{const s=(r,o,i,n=0,p=100,_=1,w="center",k=!1)=>{if(k){const m=y[r],g=m.width,b=m.height;switch(t.globalAlpha=_,w){case"center":t.save(),t.translate(o*a.display_quality,-i*a.display_quality+e.height),t.rotate(n*Math.PI/180),t.drawImage(m,-g*p/200*a.display_quality,-b*p/200*a.display_quality,g*p/100*a.display_quality,b*p/100*a.display_quality),t.restore();break;case"start":t.save(),t.translate(o*a.display_quality,-i*a.display_quality+e.height),t.rotate(n*Math.PI/180),t.drawImage(m,0,0,g*p/100*a.display_quality,b*p/100*a.display_quality),t.restore()}}else{const m=(q(u.d)*o-f(u.d)*i+u.x)*u.size/100,g=(f(u.d)*o+q(u.d)*i+u.y)*u.size/100,b=n+u.d;s(r,m,g,b,p*u.size/100,_,w,!0)}};return{stamp:s,drawRect:(r,o,i,n,p,_=0,w="center")=>{switch(t.save(),w){case"center++":t.translate(r*a.display_quality,-o*a.display_quality+e.height),t.rotate(_*Math.PI/180),t.beginPath(),t.rect(-i/2*a.display_quality,-n/2*a.display_quality,i*a.display_quality,n*a.display_quality);break;case"center":t.translate((r-i/2)*a.display_quality,-(o-n/2)*a.display_quality+e.height),t.rotate(_*Math.PI/180),t.beginPath(),t.rect(0,0,i*a.display_quality,-n*a.display_quality);break;case"start":default:t.translate(r*a.display_quality,-o*a.display_quality+e.height),t.rotate(_*Math.PI/180),t.beginPath(),t.rect(0,0,i*a.display_quality,-n*a.display_quality);break}t.fillStyle=p,t.fill(),t.restore()},drawLine:(r,o,i,n,p,_,w=0)=>{switch(t.beginPath(),w){case 0:t.moveTo((r-n*Math.sin(i)/2)*a.display_quality,-(o+n*Math.cos(i)/2)*a.display_quality+e.height),t.lineTo((r+n*Math.sin(i)/2)*a.display_quality,-(o-n*Math.cos(i)/2)*a.display_quality+e.height);break;case 1:t.moveTo(r*a.display_quality,-o*a.display_quality+e.height),t.lineTo((r+n*Math.sin(i))*a.display_quality,-(o-n*Math.cos(i))*a.display_quality+e.height);break}t.strokeStyle=_,t.lineWidth=p*a.display_quality,t.stroke()},drawText:(r,o,i,n,p,_="serif",w="left")=>{const[k,m]=[o*a.display_quality,-i*a.display_quality+e.height];t.font=`${n*a.display_quality}px ${_}`,t.textAlign=w,t.fillStyle=p,t.fillText(r,k,m)}}},I=e=>{class t{constructor(d,a,u=0,s=100,h="",l=!1){this.x=d,this.y=a,this.d=u,this.size=s,this.costume=h,this.visible=l}stamp(){this.visible&&e.stamp(this.costume,this.x,this.y,this.d,this.size)}move(d){this.x+=f(this.d)*d,this.y+=q(this.d)*d}}return t},F=(e,t,y)=>({raw_to_stage:(a,u,s=0)=>{const h=e.getBoundingClientRect(),l=((a-h.left)/y.size*100-y.x)*t.stage_width/t.display_width,c=(t.display_height-((u-h.top)/y.size*100-y.y))*t.stage_height/t.display_height,r=s+y.d;return{x:l,y:c,d:r}}}),R=async e=>{const t=document.getElementById(e.canvas_name);t.height=e.stage_height*e.display_quality,t.width=e.stage_width*e.display_quality;const y=t.getContext("2d"),{Images:d,Audios:a,Fonts:u}=await T(),s={up:!1,down:!1,left:!1,right:!1,z:!1,x:!1,c:!1,d:!1},h={x:0,y:0,clicking:!1,is_in_rect(i,n,p,_,w="center"){switch(w){case"center":return i-p/2<this.x&&this.x<i+p/2&&n-_/2<this.y&&this.y<n+_/2;case"start":default:return i<this.x&&this.x<i+p&&n<this.y&&this.y<n+_}}},l={canvas:{size:100,x:0,y:0,d:0}},c=S(t,y,d,u,e,l.canvas),r=I(c);y.imageSmoothingEnabled=!1;const o=F(t,e,l.canvas);return window.addEventListener("keydown",i=>{switch(i.key){case"ArrowUp":s.up=!0;break;case"ArrowDown":s.down=!0;break;case"ArrowLeft":s.left=!0;break;case"ArrowRight":s.right=!0;break;case"z":case"Z":s.z=!0;break;case"x":case"X":s.x=!0;break;case"c":case"C":s.c=!0;break;case"d":case"D":s.d=!0;break}}),window.addEventListener("keyup",i=>{switch(i.key){case"ArrowUp":s.up=!1;break;case"ArrowDown":s.down=!1;break;case"ArrowLeft":s.left=!1;break;case"ArrowRight":s.right=!1;break;case"z":case"Z":s.z=!1;break;case"x":case"X":s.x=!1;break;case"c":case"C":s.c=!1;break;case"d":case"D":s.d=!1;break}}),t.addEventListener("mousedown",i=>{h.clicking=!0;const n=o.raw_to_stage(i.x,i.y);h.x=n.x,h.y=n.y}),t.addEventListener("mousemove",i=>{const n=o.raw_to_stage(i.x,i.y);h.x=n.x,h.y=n.y}),t.addEventListener("mouseup",i=>{h.clicking=!1;const n=o.raw_to_stage(i.x,i.y);h.x=n.x,h.y=n.y}),{canvas:t,ctx:y,Images:d,Audios:a,Fonts:u,inputKeys:s,inputMouse:h,props:l,cLib:c,Sprite:r,for:M,while:L,loop:v}},x=2,E=800,z=480,j=1e3,$=600,K="canvas",Z={display_quality:x,stage_width:E,stage_height:z,display_width:j,display_height:$,canvas_name:K},C=async()=>{const e=await R(Z);let t=0;class y extends e.Sprite{constructor(c,r,o,i,n,p,_){super(c,r,o,20,"iyowa",!0),this.jump_x=i,this.jump_y=n,this.jump_d=p,this.age=0,this.life=_}proc(){this.x+=this.jump_x,this.y+=this.jump_y,this.d+=this.jump_d,this.jump_y-=.5,this.age+=1}}class d{constructor(c,r,o,i,n){this.igusuri={name:c,image:r,price:o,price_real:o,perf:0,perf_real:1,price_ratio:i,perf_ratio:n,level:1}}}const a=new e.Sprite(160,240,0,100,"iyowa",!0),u={},s={iyowa:0,ipc:1,ips:0,shop_tab:"igusuri",packages:[new d("きゅうくらりん","igusuri_kk",10,1.3,1.25),new d("あだぽしゃ","igusuri_ap",10,1.3,1.25),new d("1000年生きてる","igusuri_lm",10,1.3,1.25),new d("くろうばあないと","igusuri_kn",10,1.3,1.25)]},h=(()=>{const l={},c=[],r=(i,n,p)=>{if(l[i]===void 0){const _={title:n,explain:p,age:0,life:600};l[i]=_,c.push(_),console.log(`実績"${n}"を解除しました。`)}};return{dict:l,render_queue:c,check:()=>{148<=s.iyowa&&r("iyowa_1","胃が弱いからいよわです","解放条件:148いよわ生産する")},unlock:r}})();window.addEventListener("mousedown",l=>{if(P(a.x,a.y,e.inputMouse.x,e.inputMouse.y)<70)u[t]=new y(e.inputMouse.x,e.inputMouse.y,0,Math.random()*9-3,Math.random()*7+6,Math.random()*10,100),a.size+=30,s.iyowa+=s.ipc;else if(e.inputMouse.clicking)if(e.inputMouse.is_in_rect(400,345,160,30,"center"))s.shop_tab="igusuri";else if(e.inputMouse.is_in_rect(560,345,160,30,"center"))s.shop_tab="girls";else if(e.inputMouse.is_in_rect(720,345,160,30,"center"))s.shop_tab="gacha";else{s.ipc=1;for(let c=0;c<s.packages.length;c++){const r=s.packages[c].igusuri;e.inputMouse.is_in_rect(480,290-c*60,300,60,"center")&&r.price<=s.iyowa&&(s.iyowa-=r.price,r.perf,r.perf_real=r.perf_real*r.perf_ratio,r.price_real=r.price_real*r.price_ratio,r.price=Math.floor(r.price_real),r.perf=Math.floor(r.perf_real)-1),s.ipc+=r.perf}}}),e.loop(()=>{t++,a.d=f(t*2)*5,a.size=Math.max(75,40+a.size*.6),h.check(),e.inputKeys.d&&(s.ipc+=100),e.ctx.clearRect(0,0,e.canvas.width,e.canvas.height),a.stamp();for(const l in u){const c=u[l];c.age<c.life?(c.proc(),c.stamp()):delete u[l]}switch(e.cLib.drawText(`${s.iyowa.toLocaleString()} iyowa`,160,430,30,"white","serif","center"),e.cLib.drawText(`${s.ipc.toLocaleString()} ipc`,160,405,20,"white","serif","center"),e.cLib.drawText(`${s.ips.toLocaleString()} ips`,160,380,20,"white","serif","center"),e.cLib.drawRect(320,0,480,480,"#b88e98",0,"start"),e.cLib.drawRect(400,345,160,30,s.shop_tab=="igusuri"?"#eee":"#fff",0,"center++"),e.cLib.drawRect(560,345,160,30,s.shop_tab=="girls"?"#eee":"#fff",0,"center++"),e.cLib.drawRect(720,345,160,30,s.shop_tab=="gacha"?"#eee":"#fff",0,"center++"),e.cLib.drawText("Shop",560,400,50,"white","serif","center"),e.cLib.drawText("igusuri",400,340,20,"black","serif","center"),e.cLib.drawText("girls",560,340,20,"black","serif","center"),e.cLib.drawText("gacha",720,340,20,"black","serif","center"),s.shop_tab){case"igusuri":{e.cLib.drawRect(320,0,480,330,"#a87e88",0,"start");for(let l=0;l<s.packages.length;l++){const c=s.packages[l].igusuri;e.inputMouse.is_in_rect(560,290-l*60,440,60,"center")?e.cLib.drawRect(560,290-l*60,460,60,"#c89ea8",0,"center++"):e.cLib.drawRect(560,290-l*60,460,60,"#b88e98",0,"center++"),e.cLib.stamp(c.image,360,290-l*60,0,200),e.cLib.drawText(c.name,400,295-l*60,20,"white","Zen Kurenaido","start"),e.cLib.drawText(`Lv: ${c.level.toLocaleString()} | price: ${c.price.toLocaleString()} iyowa`,400,270-l*60,15,"white","Serif","start")}}}for(let l=0;l<Math.min(3,h.render_queue.length);l++){const c=h.render_queue[l];if(c.age+=1,c.life<c.age){h.render_queue.shift(),l-=1;continue}const r=((o,i)=>o<10?o/10:i-10<o?(i-o)/10:1)(c.age,c.life);e.cLib.stamp("achieve_box",160,90+l*120,0,65,r,"center"),e.cLib.drawText(c.title,160,110+l*120,20,"black","Zen Kurenaido","center"),e.cLib.drawText(`${c.explain}`,25,85+l*120,15,"black","Zen Kurenaido","start")}})};window.onload=C;
